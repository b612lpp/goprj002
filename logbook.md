init
17.12.20225
Бортовой журнал.
Начанал ноывый проект.

Цель: 
    пройтись еще раз по полученным знаниям в прошлом проекте, закрепить их переписав с чистого листа и срразу заложить фундамент для 
    масштабирования. Подготовить поле для отработки нового функционала, углубить понимание не только кодинга но и архитектуры постороения сервиса.

Задача: 
    спроектировать и реализовать сервис получения, обработки, валидации и хранения данных для закрепления  HTTP, middleware, use case, зависимости, интерфейсы. А так же добавить новый функционал для пользователя (роли, авторизация), агрегация данных, прикрутить БД, попробовать фоновые процессы ну иконечно тесты. Сейчас тесты моё слабое место.

1.  Описание сервиса.
    1.1 Пользователи
        1.1.1 Роли
            У сервиса две роли пользователь и администратор. ПОльзователь видит толлько свои данные. Администратор види данные всех пользователей. Новые пользователи автоматически получают роль пользователь. Администратор задается на уровне кода. Управление ролями - далекое будущее.
        1.1.2
            
    1.2 Показания
        1.2.1 Система обрабатывает три вида счетчиков:
            Газ: От пользователя поступает только одно значение - объемв кубометрах. 
            Вода: От пользователя поступает два значения объем горячей и холодной воды. 
            Электричество: От пользователя поступают значения дневного и ночного поаккзания, а так же сумма. 
    1.3 История.
            Предоставляет пользователю доступ к истории данных за выбранный период в соответствии с ролью. Пользователь видит данные по всем счетчикам за период. Администратор видит все переданные данные в разрезе счетчиков.
            
    1.4 Отчеты и уведомления.
            Ежедневно в конце дня сводит статистику и направляет администратору общее потребление за день.
            В конце месяца сводит данные за месяц в двух разрезах: по пользователям, по ресурсам. Формирует отчет автоматичесски.


2. Данные
    2.1 Пользователи.Пользователь определяется уникальным идентификатором типа ID внутри системы, имеет уникальный email, имя, дата регистрации, роль, статус(активен\заблокирован).
    2.2 Счетчики. Имеют структуру соответственно ресурсу. Газ - только объем, Вода - объем холодной, объем горячей. Электричество - день, ночь, сумма.
    2.3 Показания. Имеют id, тип счетчика, дату внесения, значения, пользователя. Показания не могут быть меньше нуля или предыдущего значения, у электричества должна сходится сумма день+ночь.
//Пункты 3 и 4 копипаста из интернета для порядку
3. Ограничения 
    API не содержит бизнес-логики
    репозитории не валидируют данные
    все правила находятся в use case
4. Не-функциональные требования
    сервис stateless
    конфигурация через env
    логирование всех изменений показаний


18.12
Пишу кастомный хэндлер чтобы разобраться.
пот
закопался в цепочкивызовов внутри http. понял что в голове каша. вернулся к mux. собрал запуск сервера и health

добавил middleware логирование. глобально
<<<<<<< HEAD
<<<<<<< Updated upstream
по горячим следам: разбирался с handler(). в итоге создал кастомный роутер по сути обертку над ServerMux, сам mux теперь оборачивается на этапе передачи в сервер.
=======
=======
>>>>>>> 11e7c389f233060f9d9177893403e5c357972f9f
по горячим следам: разбирался с handler(). в итоге создал кастомный роутер по сути обертку над ServerMux, сам mux теперь оборачивается на этапе передачи в сервер.

фан с контекстом.

выходной. отдыхаю, думаю об аутентификации

Добавил еще один mux для обработки приватны и публичных роутов. держусь чтобы не залезть в Chi ибо не в этом цель.


Заглушка хэндлера для сбора показаний теперь под приватной MW. сейчас в качестве аутентификатора заголовок. jwt на потом.
На подумать как уйти от префиксов пути pablic private без фреймворка. на будущий тюнинг

для разнообразия надо подумать над структурой данных. выглядит так что хранить надо группировку юзер+счетчик это объединенный идентификатор по которому будет записываться и извлекаться запись.


Есть структура и inmemory db. Осталось сшить:
     Нужно инициализировать БД, передать в создаваемый юз кейс, а юз кейс в зависимость хэндлеру(хе-хе, допёр как зависимость отрабатывает)

Обвязку сделал. Сейчас работаю над юз кейсом, надо организовать укладывание данных. Хэндлер для каждого счетчика принял решение делать отдельный. Да, плохо масштабируется, но усложнять индексами урла пока не хочу. in memory бд готова.

Хромает обработка ошибок. Пока разбираюсь с кодом.
<<<<<<< HEAD


>>>>>>> Stashed changes
=======
>>>>>>> 11e7c389f233060f9d9177893403e5c357972f9f

копилот пофиксил проверки значений.
НГ
добавил хэндлер и юзкейс для электричества. нужно обмотать ошибками и логами.

Добавил обработку ошибок. Допилил юз кейсы, вынес логику в домен. Получилось так что юз кейсы теперь идентичны тк валидация вшита в домен. Оставлю пока так возьмусь за тесты. В отладчике и по логам тестить уже хард

тестирую тесты.